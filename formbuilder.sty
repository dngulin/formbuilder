%%%
%
% Copyright 2014 Danil Gulin
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
% http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Danil Gulin.
%
% This work consists of the file formbuilder.sty
%
%%%

\ProvidesPackage{formbuilder}[2014/11/25 v1.0 Graphical Forms]

% formbuilder style rules
\newcommand*{\formbuilder@style@current}{} % style for current form (page)
\newcommand*{\formbuilder@style@default}{} % basic form (page) style

\newcommand{\NewFormStyle}[3]{\@namedef{formbuilder@geom@#1}{\newgeometry{#2}}\@namedef{formbuilder@draw@#1}{#3}}

\newcommand{\SetThisFormStyle}[1]{\renewcommand*{\formbuilder@style@current}{#1}}
\newcommand{\SetFormStyle}[1]{\renewcommand*{\formbuilder@style@default}{#1}\renewcommand*{\formbuilder@style@current}{#1}}

\NewFormStyle{default}{noheadfoot,nomarginpar,top=2cm,bottom=2cm,inner=2cm,outer=2cm}{%
	\linethickness{0.5mm}
	\put(15mm,15mm)  {\line(1,0){180mm}}
	\put(15mm,282mm) {\line(1,0){180mm}}
	\put(15mm,15mm)  {\line(0,1){267mm}}
	\put(195mm,15mm) {\line(0,1){267mm}}
	\put(15mm,5mm){\slshape FORMBUILDER DEFAULT STYLE}}
\SetFormStyle{default}

\newcommand*{\Debug}{\formbuilder@style@current}

% geometry hook
\RequirePackage{geometry}

\newcommand{\formbuilder@hook@geom}{\@nameuse{formbuilder@geom@\formbuilder@style@current}}

\let\@@outputpage\@outputpage
\def\@outputpage{\expandafter\formbuilder@hook@geom\@@outputpage}

% draw hook
\RequirePackage{atbegshi}
\RequirePackage{picture}

\newcommand*{\formbuilder@hook@draw}{\@nameuse{formbuilder@draw@\formbuilder@style@current}}

\AtBeginShipout{%
	\AtBeginShipoutUpperLeft{%
		\begin{picture}(0,0)(0,\paperheight)
		\formbuilder@hook@draw			
		\end{picture}
	}%
	\global\let\formbuilder@style@current\formbuilder@style@default %
}%

% clean pagestyle
\pagestyle{empty}